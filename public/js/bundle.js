var v=class{routes=[];add(e,s){let n=e.replace(/:(\w+)/g,"(?<$1>[^/]+)");this.routes.push({pattern:new RegExp(`^${n}$`),handler:s})}start(){window.addEventListener("hashchange",()=>this.resolve()),this.resolve()}resolve(){let e=location.hash.slice(1)||"/";for(let s of this.routes){let n=e.match(s.pattern);if(n){s.handler(n.groups??{});return}}this.routes.length>0&&this.routes[0].handler({})}};var E=class{state={connected:!1,gameState:null,agents:[],selectedAgentIds:new Set,route:location.hash||"#/"};listeners=new Set;getState(){return this.state}update(e){this.state={...this.state,...e},this.notify()}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){for(let e of this.listeners)e()}},p=new E;function t(a,e={},...s){let n=document.createElement(a);for(let[i,o]of Object.entries(e))i.startsWith("data-")?n.setAttribute(i,o):i==="class"?n.className=o:i==="for"?n.setAttribute("for",o):n.setAttribute(i,o);for(let i of s)n.append(typeof i=="string"?document.createTextNode(i):i);return n}function m(a,...e){a.replaceChildren(...e)}var j="/api/v1";async function A(a,e={}){let s=await fetch(`${j}${a}`,{headers:{"Content-Type":"application/json",...e.headers},credentials:"include",...e});if(!s.ok){let n=await s.json().catch(()=>({error:"UNKNOWN",message:s.statusText}));throw new R(n.error??"UNKNOWN",n.message??s.statusText,s.status)}return s.json()}var R=class extends Error{constructor(s,n,i){super(n);this.code=s;this.status=i;this.name="ApiError"}};function I(a,e){return A("/agents",{method:"POST",body:JSON.stringify({name:a,personality:e})})}function T(a,e="elimination"){return A("/games",{method:"POST",body:JSON.stringify({agents:a,mode:e})})}function $(a){return A(`/games/${encodeURIComponent(a)}/start`,{method:"POST"})}var P=[{id:"preset-philosopher",name:"The Philosopher",emoji:"\u{1F9E0}",description:"Deep thinker who questions everything"},{id:"preset-comedian",name:"The Comedian",emoji:"\u{1F602}",description:"Quick wit and sharp humor"},{id:"preset-strategist",name:"The Strategist",emoji:"\u265F\uFE0F",description:"Calculated moves, always planning"},{id:"preset-rebel",name:"The Rebel",emoji:"\u{1F525}",description:"Breaks rules and challenges norms"},{id:"preset-poet",name:"The Poet",emoji:"\u2728",description:"Beauty in every word"},{id:"preset-scientist",name:"The Scientist",emoji:"\u{1F52C}",description:"Evidence-based and analytical"},{id:"preset-mystic",name:"The Mystic",emoji:"\u{1F52E}",description:"Enigmatic and mysterious"},{id:"preset-warrior",name:"The Warrior",emoji:"\u2694\uFE0F",description:"Bold, direct, fearless"}];function D(a){let e=new Set;function s(){let o=t("header",{class:"picker-header"},t("h1",{},"\u2694\uFE0F Choose Your Fighters"),t("p",{},"Select 2 or more agents to battle")),d=t("div",{class:"agent-grid",role:"group","aria-label":"Agent selection"});for(let g of P){let c=t("button",{class:`agent-tile${e.has(g.id)?" selected":""}`,"aria-pressed":e.has(g.id)?"true":"false","aria-label":`Select ${g.name}`,"data-id":g.id,type:"button"},t("div",{class:"emoji"},g.emoji),t("div",{class:"name"},g.name),t("div",{class:"desc"},g.description));c.addEventListener("click",()=>n(g.id)),d.append(c)}let h=t("button",{class:"btn btn-primary",type:"button",...e.size<2?{disabled:""}:{},"aria-label":"Start game"},"\u{1F3AE} Start Game");e.size<2&&h.setAttribute("disabled",""),h.addEventListener("click",i);let l=t("div",{class:"picker-actions"},h);m(a,o,d,l)}function n(o){e.has(o)?e.delete(o):e.add(o),p.update({selectedAgentIds:new Set(e)}),s()}async function i(){if(!(e.size<2))try{let o=[];for(let h of e){let l=P.find(c=>c.id===h);if(!l)continue;let g=await I(l.name,`${l.emoji} ${l.description}. I am ${l.name}.`);o.push(g.id)}let d=await T(o);await $(d.id),location.hash=`#/game/${d.id}`}catch(o){let d=t("p",{class:"error",role:"alert"},`Error: ${o instanceof Error?o.message:"Unknown error"}`);a.append(d)}}s()}var y=class{ws=null;reconnectAttempts=0;maxReconnectAttempts=10;gameId=null;reconnectTimer=null;onFullState;onRoundStart;onChallenge;onResponse;onElimination;onGameEnd;onError;onDisconnected;onConnectionChange;connect(e){this.gameId=e,this.reconnectAttempts=0,this.doConnect()}disconnect(){this.gameId=null,this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(1e3,"Client disconnect"),this.ws=null)}doConnect(){if(!this.gameId)return;let s=`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/ws`;this.ws=new WebSocket(s),this.ws.onopen=()=>{this.reconnectAttempts=0,this.onConnectionChange?.(!0),this.ws.send(JSON.stringify({type:"SUBSCRIBE",gameId:this.gameId})),this.ws.send(JSON.stringify({type:"RESYNC",gameId:this.gameId}))},this.ws.onmessage=n=>{try{let i=JSON.parse(n.data);this.handleMessage(i)}catch{}},this.ws.onclose=n=>{this.onConnectionChange?.(!1),!(n.code===1e3||n.code===1001)&&this.scheduleReconnect()},this.ws.onerror=()=>{this.ws?.close()}}scheduleReconnect(){if(!this.gameId)return;if(this.reconnectAttempts>=this.maxReconnectAttempts){this.onDisconnected?.("Max reconnection attempts reached");return}let e=Math.min(1e3*2**this.reconnectAttempts,3e4);this.reconnectAttempts++,this.reconnectTimer=setTimeout(()=>this.doConnect(),e)}handleMessage(e){switch(e.type){case"FULL_STATE":this.onFullState?.(e.data);break;case"ROUND_START":this.onRoundStart?.(e.data);break;case"CHALLENGE":this.onChallenge?.(e.data);break;case"RESPONSE":this.onResponse?.(e.data);break;case"ELIMINATION":this.onElimination?.(e.data);break;case"GAME_END":this.onGameEnd?.(e.data);break;case"ERROR":this.onError?.(e.data);break}}};function G(a){let e=!1;function s(){let o=[...p.getState().gameState?.agents??[]].sort((c,b)=>b.score-c.score),d=t("aside",{class:`scoreboard${e?" collapsed":""}`,"aria-label":"Scoreboard"}),h=t("button",{class:"scoreboard-toggle",type:"button","aria-label":e?"Expand scoreboard":"Collapse scoreboard"},e?"\u25B6":"\u25BC");h.addEventListener("click",()=>{e=!e,s()});let l=t("div",{class:"scoreboard-header"},t("h2",{},"\u{1F3C6} Scores"),h);d.append(l);let g=t("div",{class:"scoreboard-list",role:"list"});o.forEach((c,b)=>{let r=t("div",{class:`scoreboard-entry${c.eliminated?" eliminated":""}`,role:"listitem","aria-label":`${c.name}: ${c.score} points${c.eliminated?", eliminated":""}`},t("span",{class:"rank"},`${b+1}.`),t("span",{class:"agent-emoji"},c.avatar??"\u{1F916}"),t("span",{class:"agent-info"},t("span",{class:"agent-name"},c.name)),t("span",{class:"score"},String(c.score)));g.append(r)}),d.append(g),m(a,d)}p.subscribe(s),s()}function M(a){return a.replace(/<[^>]*>/g,"")}function S(a,e=500){let s=M(a);return s.length>e?s.slice(0,e)+"\u2026":s}var U={debate:"\u{1F5E3}\uFE0F",strategy:"\u265F\uFE0F",creative:"\u{1F3A8}",trivia:"\u{1F4DA}"};function k(a,e){let s=[],n=t("article",{class:"challenge-display"},t("div",{class:"challenge-type"},`${U[e.type]??"\u2753"} ${e.type}`),t("p",{class:"challenge-description"},S(e.description)));if(s.push(n),e.responses&&e.responses.length>0){let i=t("div",{class:"response-list","aria-label":"Agent responses",role:"list"});for(let o of e.responses){let d=t("article",{class:"response-card",role:"listitem"},t("div",{class:"agent-name"},o.agentDisplayId),t("p",{class:"response-text"},S(o.response)),t("div",{class:"response-score"},`Score: ${o.score}`));i.append(d)}s.push(i)}m(a,...s)}function N(a,e,s,n){let i=`${location.origin}/#/game/${encodeURIComponent(n)}`,o=`\u{1F3C6} ${e} won Soul vs Soul with ${s} points! Watch the replay: ${i} #SoulVsSoul`,d=`https://twitter.com/intent/tweet?text=${encodeURIComponent(o)}`,h=t("a",{class:"btn-share",href:d,target:"_blank",rel:"noopener noreferrer","aria-label":"Share results on X"},"\u{1F426} Share to X"),l=t("section",{class:"share-card"},t("h3",{},"Share Your Results"),t("p",{class:"share-text"},`${e} dominated with ${s} points!`),h);m(a,l)}function L(a,e){let s=new y,n=null,i=!1,o="",d=0,h=t("div",{class:"game-layout"}),l=t("div",{class:"game-arena"}),g=t("div",{});h.append(l,g),m(a,h),G(g),s.onFullState=r=>{n=r,p.update({gameState:r,agents:r.agents}),c()},s.onRoundStart=r=>{n&&(n.round=r.round,p.update({gameState:{...n}})),c()},s.onChallenge=r=>{n&&(n.currentChallenge={type:r.challenge.type,description:r.challenge.publicDescription,responses:[]},p.update({gameState:{...n}})),c()},s.onResponse=r=>{if(n?.currentChallenge){n.currentChallenge.responses||(n.currentChallenge.responses=[]),n.currentChallenge.responses.push({agentDisplayId:r.agentId,response:S(r.response),score:r.score});let u=n.agents.find(f=>f.displayId===r.agentId);u&&(u.score+=r.score),p.update({gameState:{...n}})}c()},s.onElimination=r=>{if(n){let u=n.agents.find(f=>f.displayId===r.agentId);u&&(u.eliminated=!0),p.update({gameState:{...n}})}c()},s.onGameEnd=r=>{i=!0,o=r.winner.name,d=r.winner.score,c()},s.onConnectionChange=r=>{p.update({connected:r});let u=document.getElementById("connection-status");u&&(u.textContent=r?"\u{1F7E2} Live":"\u{1F534} Reconnecting\u2026",u.className=`connection-status ${r?"connected":"disconnected"}`)},s.onError=r=>{let u=t("p",{class:"error",role:"alert"},`Error: ${r.message}`);l.append(u)},s.onDisconnected=r=>{let u=t("p",{class:"error",role:"alert"},`Disconnected: ${r}`);l.append(u)};function c(){let r=[];if(i){let f=t("section",{class:"game-end"},t("h2",{},"\u{1F3C6} Game Over!"),t("p",{class:"winner-name"},o),t("p",{},`Score: ${d}`));r.push(f);let x=t("div",{});r.push(x),m(l,...r),N(x,o,d,e);return}if(!n){r.push(t("p",{},"Connecting to game\u2026")),m(l,...r);return}let u=t("header",{class:"arena-header"},t("span",{class:"round-indicator"},`Round ${n.round}`),t("span",{class:"spectator-count","aria-label":"Spectator count"},`\u{1F441} ${n.spectatorCount}`));if(r.push(u),n.currentChallenge){let f=t("div",{});r.push(f),m(l,...r),k(f,n.currentChallenge);return}r.push(t("p",{class:"waiting"},"Waiting for next challenge\u2026")),m(l,...r)}s.connect(e);let b=p.subscribe(()=>{p.getState().route.includes(e)||(s.disconnect(),b())})}var C=document.getElementById("app"),w=new v;w.add("/",()=>{p.update({route:"#/"}),D(C)});w.add("/game/:id",a=>{let e=a.id;e&&(p.update({route:`#/game/${e}`}),L(C,e))});w.add("/leaderboard",()=>{p.update({route:"#/leaderboard"});let a=t("section",{},t("h1",{},"\u{1F3C6} Leaderboard"),t("p",{},"Coming soon\u2026"));m(C,a)});w.start();
